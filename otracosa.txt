<?php
// busqueda.php - RF-17, RF-22, RF-23, RF-24
// Sistema completo de búsqueda y filtros de servicios

require_once __DIR__ . '/config/config.php';
require_once __DIR__ . '/core/Database.php';

$db = Database::getInstance()->getConnection();

// Obtener parámetros de búsqueda
$query = isset($_GET['q']) ? trim($_GET['q']) : '';
$categoria = isset($_GET['categoria']) ? (int)$_GET['categoria'] : 0;
$precioMin = isset($_GET['precio_min']) ? (float)$_GET['precio_min'] : 0;
$precioMax = isset($_GET['precio_max']) ? (float)$_GET['precio_max'] : 999999;
$calificacion = isset($_GET['calificacion']) ? (int)$_GET['calificacion'] : 0;
$ubicacion = isset($_GET['ubicacion']) ? trim($_GET['ubicacion']) : '';
$ordenar = isset($_GET['ordenar']) ? $_GET['ordenar'] : 'recientes';
$pagina = isset($_GET['pagina']) ? (int)$_GET['pagina'] : 1;
$porPagina = 12;
$offset = ($pagina - 1) * $porPagina;

// Construir query SQL dinámico
$sql = "SELECT DISTINCT
            s.id_servicio,
            s.nombre,
            s.descripcion,
            s.precio,
            s.duracion_estimada,
            s.fecha_creacion,
            c.nombre as categoria_nombre,
            p.id_proveedor,
            p.calificacion_promedio,
            p.total_calificaciones,
            u.nombre as proveedor_nombre,
            u.direccion as proveedor_ubicacion,
            (SELECT ruta_imagen FROM imagen_servicio 
             WHERE id_servicio = s.id_servicio AND es_principal = 1 
             LIMIT 1) as imagen_principal
        FROM servicio s
        INNER JOIN categoria c ON s.id_categoria = c.id_categoria
        INNER JOIN proveedor p ON s.id_proveedor = p.id_proveedor
        INNER JOIN usuario u ON p.id_usuario = u.id_usuario
        WHERE s.estado = 'disponible'";

$params = [];

// RF-22: Búsqueda por palabras clave
if (!empty($query)) {
    $sql .= " AND (s.nombre LIKE ? OR s.descripcion LIKE ? OR u.nombre LIKE ?)";
    $searchTerm = "%{$query}%";
    $params[] = $searchTerm;
    $params[] = $searchTerm;
    $params[] = $searchTerm;
}

// Filtro por categoría
if ($categoria > 0) {
    $sql .= " AND s.id_categoria = ?";
    $params[] = $categoria;
}

// RF-24: Filtro por rango de precios
if ($precioMin > 0 || $precioMax < 999999) {
    $sql .= " AND s.precio BETWEEN ? AND ?";
    $params[] = $precioMin;
    $params[] = $precioMax;
}

// RF-24: Filtro por calificación mínima
if ($calificacion > 0) {
    $sql .= " AND p.calificacion_promedio >= ?";
    $params[] = $calificacion;
}

// RF-23: Filtro por ubicación geográfica
if (!empty($ubicacion)) {
    $sql .= " AND u.direccion LIKE ?";
    $params[] = "%{$ubicacion}%";
}

// Ordenamiento
switch ($ordenar) {
    case 'precio_asc':
        $sql .= " ORDER BY s.precio ASC";
        break;
    case 'precio_desc':
        $sql .= " ORDER BY s.precio DESC";
        break;
    case 'calificacion':
        $sql .= " ORDER BY p.calificacion_promedio DESC";
        break;
    case 'nombre':
        $sql .= " ORDER BY s.nombre ASC";
        break;
    default: // recientes
        $sql .= " ORDER BY s.fecha_creacion DESC";
}

// Contar total de resultados
$sqlCount = preg_replace('/SELECT DISTINCT.*FROM/s', 'SELECT COUNT(DISTINCT s.id_servicio) as total FROM', $sql);
$sqlCount = preg_replace('/ORDER BY.*$/s', '', $sqlCount);
$stmtCount = $db->prepare($sqlCount);
$stmtCount->execute($params);
$totalResultados = $stmtCount->fetch()['total'];
$totalPaginas = ceil($totalResultados / $porPagina);

// Agregar paginación
$sql .= " LIMIT ? OFFSET ?";
$params[] = $porPagina;
$params[] = $offset;

// Ejecutar búsqueda
$stmt = $db->prepare($sql);
$stmt->execute($params);
$servicios = $stmt->fetchAll();

// Obtener todas las categorías para el filtro
$stmtCat = $db->query("SELECT * FROM categoria WHERE activo = 1 ORDER BY nombre");
$categorias = $stmtCat->fetchAll();

?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Búsqueda de Servicios</title>
    <link rel="stylesheet" href="<?= BASE_URL ?>/css/styles.css">
</head>
<body>
    <?php include __DIR__ . '/app/views/layouts/header.php'; ?>
    
    <div class="container mt-3">
        <h1>Búsqueda de Servicios</h1>
        
        <!-- Formulario de búsqueda y filtros -->
        <div class="card mb-3">
            <form method="GET" action="/busqueda.php" id="formBusqueda">
                <div class="grid grid-4">
                    <!-- Búsqueda por texto -->
                    <div class="form-group">
                        <label>Buscar:</label>
                        <input type="text" name="q" value="<?= htmlspecialchars($query) ?>" 
                               placeholder="Servicio, proveedor...">
                    </div>
                    
                    <!-- Categoría -->
                    <div class="form-group">
                        <label>Categoría:</label>
                        <select name="categoria">
                            <option value="0">Todas</option>
                            <?php foreach ($categorias as $cat): ?>
                                <option value="<?= $cat['id_categoria'] ?>" 
                                    <?= $categoria == $cat['id_categoria'] ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($cat['nombre']) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    
                    <!-- Ubicación -->
                    <div class="form-group">
                        <label>Ubicación:</label>
                        <input type="text" name="ubicacion" value="<?= htmlspecialchars($ubicacion) ?>" 
                               placeholder="Ciudad, barrio...">
                    </div>
                    
                    <!-- Calificación -->
                    <div class="form-group">
                        <label>Calificación mínima:</label>
                        <select name="calificacion">
                            <option value="0">Todas</option>
                            <?php for ($i = 5; $i >= 1; $i--): ?>
                                <option value="<?= $i ?>" <?= $calificacion == $i ? 'selected' : '' ?>>
                                    <?= $i ?> ⭐ o más
                                </option>
                            <?php endfor; ?>
                        </select>
                    </div>
                    
                    <!-- Precio mínimo -->
                    <div class="form-group">
                        <label>Precio mínimo:</label>
                        <input type="number" name="precio_min" value="<?= $precioMin ?>" 
                               min="0" step="100">
                    </div>
                    
                    <!-- Precio máximo -->
                    <div class="form-group">
                        <label>Precio máximo:</label>
                        <input type="number" name="precio_max" value="<?= $precioMax ?>" 
                               min="0" step="100">
                    </div>
                    
                    <!-- Ordenar por -->
                    <div class="form-group">
                        <label>Ordenar por:</label>
                        <select name="ordenar">
                            <option value="recientes" <?= $ordenar == 'recientes' ? 'selected' : '' ?>>
                                Más recientes
                            </option>
                            <option value="precio_asc" <?= $ordenar == 'precio_asc' ? 'selected' : '' ?>>
                                Precio: menor a mayor
                            </option>
                            <option value="precio_desc" <?= $ordenar == 'precio_desc' ? 'selected' : '' ?>>
                                Precio: mayor a menor
                            </option>
                            <option value="calificacion" <?= $ordenar == 'calificacion' ? 'selected' : '' ?>>
                                Mejor calificados
                            </option>
                            <option value="nombre" <?= $ordenar == 'nombre' ? 'selected' : '' ?>>
                                Nombre A-Z
                            </option>
                        </select>
                    </div>
                    
                    <div class="form-group d-flex align-center">
                        <button type="submit" class="btn btn-primary">Buscar</button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Resultados -->
        <div class="mb-2">
            <p>Se encontraron <strong><?= $totalResultados ?></strong> resultados</p>
        </div>
        
        <?php if (empty($servicios)): ?>
            <div class="alert alert-warning">
                No se encontraron servicios con los criterios ingresados
            </div>
        <?php else: ?>
            <div class="grid grid-3">
                <?php foreach ($servicios as $servicio): ?>
                    <div class="card">
                        <?php if ($servicio['imagen_principal']): ?>
                            <img src="<?= BASE_URL . '/' . $servicio['imagen_principal'] ?>" 
                                 alt="<?= htmlspecialchars($servicio['nombre']) ?>"
                                 style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px 8px 0 0;">
                        <?php endif; ?>
                        
                        <h3><?= htmlspecialchars($servicio['nombre']) ?></h3>
                        <p class="badge badge-primary"><?= htmlspecialchars($servicio['categoria_nombre']) ?></p>
                        
                        <p><?= substr(htmlspecialchars($servicio['descripcion']), 0, 100) ?>...</p>
                        
                        <div class="d-flex justify-between align-center mb-1">
                            <span><strong>$<?= number_format($servicio['precio'], 2) ?></strong></span>
                            <?php if ($servicio['total_calificaciones'] > 0): ?>
                                <span>⭐ <?= number_format($servicio['calificacion_promedio'], 1) ?> 
                                    (<?= $servicio['total_calificaciones'] ?>)</span>
                            <?php endif; ?>
                        </div>
                        
                        <p><small>Por: <?= htmlspecialchars($servicio['proveedor_nombre']) ?></small></p>
                        <p><small>📍 <?= htmlspecialchars($servicio['proveedor_ubicacion']) ?></small></p>
                        
                        <a href="<?= BASE_URL ?>/servicio.php?id=<?= $servicio['id_servicio'] ?>" 
                           class="btn btn-primary btn-sm">Ver detalles</a>
                    </div>
                <?php endforeach; ?>
            </div>
            
            <!-- Paginación -->
            <?php if ($totalPaginas > 1): ?>
                <div class="text-center mt-3">
                    <?php
                    $urlBase = $_SERVER['PHP_SELF'] . '?';
                    foreach ($_GET as $key => $value) {
                        if ($key !== 'pagina') {
                            $urlBase .= urlencode($key) . '=' . urlencode($value) . '&';
                        }
                    }
                    ?>
                    
                    <?php if ($pagina > 1): ?>
                        <a href="<?= $urlBase ?>pagina=<?= $pagina - 1 ?>" class="btn btn-secondary btn-sm">
                            ← Anterior
                        </a>
                    <?php endif; ?>
                    
                    <span>Página <?= $pagina ?> de <?= $totalPaginas ?></span>
                    
                    <?php if ($pagina < $totalPaginas): ?>
                        <a href="<?= $urlBase ?>pagina=<?= $pagina + 1 ?>" class="btn btn-secondary btn-sm">
                            Siguiente →
                        </a>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
        <?php endif; ?>
    </div>
    
    <?php include __DIR__ . '/app/views/layouts/footer.php'; ?>
</body>
</html>


